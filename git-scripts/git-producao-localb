#!/bin/bash
REPOSITORIO_PATH=`git rev-parse --show-toplevel`
BRANCH="master"
PRE_LOCAL_EXTRACT_CMD=`git config --get producao.preLocalExtract`
PRE_LOCAL_BUILD_CMD=`git config --get producao.preLocalBuild`

function usage {
	echo "Usage:"
	echo " $(basename $0) [-c [-m commit-message]] [-r] [-b branch]"
	echo
	echo "Flags:"
	echo "  -a	Execute commit -a"
	echo "  -c	Execute interactive commit before"
	echo "  -r	Execute interactive rebase before"
	echo "  -b	The branch to be used to build the book"
	echo "  -h	This help message"
	echo
	echo "Git configs:"
	echo
	echo "producao.preLocalExtract: command to be executed before extract tag"
	echo "producao.preLocalBuild: command to be executed before build"
	echo
}

function commit {
	git commit --interactive
}

function commit_a {
	git commit -a
}


function run_gitg {
	gitg
}

function rebase {
	git rebase --interactive
}

while getopts “hacm:grb:” OPTION
do
     case $OPTION in
         h)
             usage
             exit 1
             ;;
         a)
             COMMIT_A=1
             ;;
         c)
             COMMIT=1
             ;;
         g)
             GITG=1
             ;;
         r)
             REBASE=1
             ;;
         b)
             BRANCH=$OPTARG
             ;;
         ?)
             usage
             exit
             ;;
     esac
done

if [[ $GITG == 1 ]]
then
	run_gitg
fi

if [[ $COMMIT_A == 1 ]]
then
	commit_a
elif [[ $COMMIT == 1 ]]
then
	commit
fi

if [[ $REBASE == 1 ]]
then
	rebase
fi

echo C = $COMMIT R = $REBASE B= $BRANCH

$PRE_LOCAL_EXTRACT_CMD

cd $REPOSITORIO_PATH
rm -rf releases/$BRANCH
git archive --prefix="releases/$BRANCH/" $BRANCH | tar -x

# cd $REPOSITORIO_PATH/releases/$BRANCH/livro

$PRE_LOCAL_BUILD_CMD

~/ambiente/asciidoc-8.6.8/a2x.py -v -f pdf --icons -a docinfo1 -a lang=pt-BR -d book --dblatex-opts "-T computacao -P latex.babel.language=brazilian"  -a livro-pdf releases/$BRANCH/livro/livro.asc > releases/$BRANCH/livro/log.txt
cat log.txt
